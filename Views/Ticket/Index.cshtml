@model IEnumerable<NoSQLproject.Models.Ticket>

@{
    ViewData["Title"] = "All Tickets";
}

<div class="container mt-4">
    <h2 class="mb-4 fw-bold">Overview tickets</h2>

    <!-- Search + Navigation buttons -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <form method="get" class="d-flex align-items-center w-50">
            <input type="text"
                   name="searchEmail"
                   value="@Context.Request.Query["searchEmail"]"
                   class="form-control w-100"
                   placeholder="Filter by email" />
            <button type="submit" class="btn btn-primary ms-2">Search</button>
        </form>

        <div class="d-flex">
            <a asp-action="CurrentIncidents" class="btn btn-secondary me-2">CURRENT INCIDENTS</a>
            <a asp-action="Create" class="btn btn-success me-2">CREATE INCIDENT</a>

            <!-- Archive button form OUTSIDE the GET form -->
            <form asp-action="ArchiveOldTickets" method="post" class="d-inline">
                <button type="submit" class="btn btn-warning"
                        onclick="return confirm('Are you sure you want to archive tickets older than 1 year?')">
                    ARCHIVE OLD TICKETS
                </button>
            </form>
        </div>
    </div>


    <!-- Feedback message -->
    @if (TempData["Message"] != null)
    {
        var alertClass = TempData["MessageType"]?.ToString() == "success"
        ? "alert-success"
        : "alert-info";

        <div class="alert @alertClass mt-3">
            @TempData["Message"]
        </div>
    }

    <!-- Tickets table -->
    <table class="table table-bordered table-hover align-middle">
        <thead class="table-light">
        <tr>
            <th>
                <a asp-action="Index"
                   asp-route-sortOrder="@ViewData["IdSortParam"]"
                   asp-route-searchEmail="@Context.Request.Query["searchEmail"]"
                   class="text-decoration-none">ID</a>
            </th>
            <th>Subject</th>
            <th>
                <a asp-action="Index"
                   asp-route-sortOrder="@ViewData["UserSortParam"]"
                   asp-route-searchEmail="@Context.Request.Query["searchEmail"]"
                   class="text-decoration-none">User</a>
            </th>
            <th>
                <a asp-action="Index"
                   asp-route-sortOrder="@ViewData["DateSortParam"]"
                   asp-route-searchEmail="@Context.Request.Query["searchEmail"]"
                   class="text-decoration-none">Created</a>
            </th>
            <th>
                <a asp-action="Index"
                   asp-route-sortOrder="@ViewData["DeadlineSortParam"]"
                   asp-route-searchEmail="@Context.Request.Query["searchEmail"]"
                   class="text-decoration-none">Deadline</a>
            </th>
            <th>Status</th>
        </tr>
        </thead>

        <tbody>
        @foreach (var ticket in Model)
        {
            <tr data-href="@Url.Action("Details", "Ticket", new { ticketNumber = ticket.TicketNumber })" style="cursor:pointer;">
                <td>@ticket.TicketNumber</td>
                <td>@ticket.Title</td>
                <td>
                    @ticket.CreatedBy?.FullName
                    <br />
                    <small class="text-muted">@ticket.CreatedBy?.Email</small>
                </td>
                <td>@ticket.CreatedAt.ToShortDateString()</td>
                <td class="@(ticket.Deadline < DateTime.UtcNow ? "text-danger fw-bold" : "")">
                    @((ticket.Deadline.HasValue)
                        ? ticket.Deadline.Value.ToShortDateString()
                        : "â€”")
                </td>
                <td>@ticket.State</td>
            </tr>
        }
        </tbody>
    </table>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll("tr[data-href]").forEach(row => {
            row.addEventListener("click", () => {
                window.location = row.dataset.href;
            });
        });
    });

        setTimeout(() => {
        document.querySelectorAll('.alert').forEach(a => a.remove());
    }, 4000); // message disappears after 4 seconds
</script>


