@model CreateTicketViewModel
@{
    ViewData["Title"] = "Manage Ticket";
    // Define the list of priorities for the buttons
    var priorities = Enum.GetNames(typeof(Priority));
}
<link rel="stylesheet" href="~/css/ticket.css"/>
<div class="d-flex justify-content-between align-items-end">
    <div>
        <h2>Ticket @Model.Ticket.TicketNumber — @Model.Ticket.Title</h2>
        <h6 class="text-secondary">Id: @Model.Ticket.Id</h6>
    </div>

    <div class="mb-3 d-flex gap-2">
        <a asp-action="Manage" asp-route-ticketNumber="@Model.Ticket.TicketNumber" class="btn btn-warning text-white">
            Manage
        </a>
        <div>
            <a asp-action="Edit" asp-route-ticketNumber="@Model.Ticket.TicketNumber" class="btn btn-primary w-100">
                Edit
            </a>
        </div>
        <div>
            <form asp-action="Delete" asp-route-ticketNumber="@Model.Ticket.TicketNumber" method="post"
                  class="d-inline w-100">
                <button type="submit" class="btn btn-danger w-100"
                        onclick="return confirm('Delete this ticket?');">
                    Delete
                </button>
            </form>
        </div>
        <div>
            <a asp-action="Details" asp-route-ticketNumber="@Model.Ticket.TicketNumber" class="btn btn-secondary w-100">Back</a>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body">

        <form asp-action="Manage" method="post" id="ticket-manage-form" class="mb-0">
            <input type="hidden" asp-for="Ticket.Id"/>
            <input type="hidden" asp-for="Ticket.TicketNumber"/>
            <input type="hidden" asp-for="Ticket.Title"/>
            <input type="hidden" asp-for="Ticket.Description"/>
            <input type="hidden" asp-for="Ticket.IncidentType"/>
            <input type="hidden" asp-for="Ticket.CreatedAt"/>
            <input type="hidden" asp-for="Ticket.CreatedBy"/>
            <input type="hidden" asp-for="CreatedByUserId"/>

            <input type="hidden" asp-for="Ticket.Priority" id="HiddenPriority"/>

            <div class="row">
                <div class="col-md-6 border-end">
                    <dl class="row ticket-details">
                        <dt class="col-sm-4 text-muted fw-bold">Ticket Number</dt>
                        <dd class="col-sm-8">@Model.Ticket.TicketNumber</dd>

                        <dt class="col-sm-4 text-muted fw-bold">Priority</dt>
                        <dd class="col-sm-8">
                            <div class="ticket-field-value">
                                <div class="btn-group ticket-priority-group" role="group" aria-label="Ticket Priority">
                                @foreach (var p in priorities)
                                {
                                    // Use a data attribute to store the enum value
                                    var priorityValue = p;
                                    var buttonClass = "";
                                    var dataPriorityValue = ((int)Enum.Parse<Priority>(p)).ToString();

                                    // Determine button color
                                    switch (p)
                                    {
                                        case "P1": buttonClass = "btn-danger"; break;
                                        case "P2": buttonClass = "btn-warning text-dark"; break;
                                        case "P3": buttonClass = "btn-info text-dark"; break;
                                        default: buttonClass = "btn-secondary"; break;
                                    }

                                        <button type="button"
                                                class="btn @buttonClass btn-sm priority-btn @(Model.Ticket.Priority.ToString() == p ? "active" : "")"
                                                data-priority-name="@p"
                                                data-priority-value="@dataPriorityValue">
                                            @p
                                        </button>
                                    }
                                </div>
                            </div>
                        </dd>

                        <dt class="col-sm-4 text-muted fw-bold">Incident Type</dt>
                        <dd class="col-sm-8">@Model.Ticket.IncidentType</dd>

                        <dt class="col-sm-4 text-muted fw-bold">Description</dt>
                        <dd class="col-sm-8 text-wrap ticket-field-long">@Model.Ticket.Description</dd>

                    </dl>
                </div>

                <div class="col-md-6">
                    <dl class="row ticket-details">

                        <dt class="col-sm-4 text-muted fw-bold">State</dt>
                        <dd class="col-sm-8">
                            <div class="ticket-field-value">
                                <select asp-for="Ticket.State" class="form-select form-select-sm ticket-select-pill"
                                        asp-items="Html.GetEnumSelectList<State>()"></select>
                            </div>
                            <span asp-validation-for="Ticket.State" class="text-danger small d-block mt-1"></span>
                        </dd>

                        <dt class="col-sm-4 text-muted fw-bold">Created At</dt>
                        <dd class="col-sm-8">@Model.Ticket.CreatedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</dd>

                        <dt class="col-sm-4 text-muted fw-bold">Deadline</dt>
                        <dd class="col-sm-8 text-danger">
                            @(Model.Ticket.Deadline.HasValue
                                ? Model.Ticket.Deadline.Value.ToLocalTime().ToString("yyyy-MM-dd HH:mm")
                                : "—")
                        </dd>

                        <dt class="col-sm-4 text-muted fw-bold">Resolved At</dt>
                        <dd class="col-sm-8">
                            @(Model.Ticket.ResolvedAt.HasValue
                                ? Model.Ticket.Deadline.Value.ToLocalTime().ToString("yyyy-MM-dd HH:mm")
                                : "—")
                        </dd>
                    </dl>
                </div>
            </div>

            @if (Model.HandledByUserIds != null)
            {
                @for (var i = 0; i < Model.HandledByUserIds.Count; i++)
                {
                    <input type="hidden" asp-for="HandledByUserIds[i]"/>
                }
            }
        </form>
    </div>
</div>

<h5 class="mt-4">Created By</h5>
@if (Model.Ticket.CreatedBy is not null)
{
    <div class="card border-0 mb-3 card-fit card-strong" style="border-radius: 12px;">
        <div class="card-body p-0 ">
            <div class="d-flex align-items-center gap-sm-2">
                <div class="fw-semibold">@Model.Ticket.CreatedBy.FullName</div>
                <div
                    class="text-muted small">@Model.Ticket.CreatedBy.EmployeeNumber | @Model.Ticket.CreatedBy.TypeOfUser</div>

            </div>

            <div class="mt-2 d-flex align-items-center gap-2 text-muted">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                     class="bi bi-envelope" viewBox="0 0 16 16" aria-hidden="true">
                    <path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v.217L8 8.083.0 4.217V4z"/>
                    <path
                        d="M0 4.697v7.104l5.803-3.558L0 4.697zm6.761 3.396-6.57 4.027A2 2 0 0 0 2 14h12a2 2 0 0 0 1.809-1.88l-6.57-4.027L8 9.583l-1.239-.49zM16 4.697l-5.803 3.546L16 11.801V4.697z"/>
                </svg>

                <a class="text-muted text-decoration-none"
                   href="mailto:@Model.Ticket.CreatedBy.Email">@Model.Ticket.CreatedBy.Email</a>
            </div>
        </div>
    </div>
}
else
{
    <p class="text-muted">No creator assigned.</p>
}


<h5 class="mt-4">Handled By</h5>
<div class="card">
    <div class="card-body">
        <label class="form-label fw-bold">Assign Handlers</label>
        <select form="ticket-manage-form" asp-for="HandledByUserIds" asp-items="Model.UsersSelect" class="form-select"
                multiple size="6"></select>
        <div class="form-text">Hold Ctrl/Cmd to select multiple handlers.</div>
    </div>
</div>

<div class="d-flex justify-content-end gap-3 mt-4">
    <a asp-action="Details" asp-route-ticketNumber="@Model.Ticket.TicketNumber"
       class="btn btn-outline-secondary">Cancel</a>
    <button type="submit" form="ticket-manage-form" class="btn btn-success">
        Save Management Changes
    </button>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial"/>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const hiddenPriorityInput = document.getElementById('HiddenPriority');
            const priorityButtons = document.querySelectorAll('.priority-btn');

            // Initialize the hidden field with the current value
            // Note: If you use the Enum value (int), you need to convert it here. 
            // The Razor code below sets the name (string) by default for the hidden input.
            // Let's ensure the default active button is set based on the current model value.
            if (hiddenPriorityInput && '@Model.Ticket.Priority' !== '') {
                // If the model priority is set, ensure the hidden field reflects the string name
                hiddenPriorityInput.value = '@Model.Ticket.Priority';
            }

            // Add click listener to all buttons
            priorityButtons.forEach(button => {
                button.addEventListener('click', function () {
                    // Remove 'active' class from all buttons
                    priorityButtons.forEach(btn => btn.classList.remove('active'));

                    // Add 'active' class to the clicked button
                    this.classList.add('active');

                    // Update the hidden input field with the priority name (e.g., "P1")
                    hiddenPriorityInput.value = this.dataset.priorityName;
                });
            });

            // Set the initial active state based on the current model value
            // This ensures the button is highlighted on page load
            if ('@Model.Ticket.Priority' !== '') {
                const currentPriority = '@Model.Ticket.Priority';
                const activeBtn = document.querySelector(`.priority-btn[data-priority-name="${currentPriority}"]`);
                if (activeBtn) {
                    activeBtn.classList.add('active');
                }
            }
        });
    </script>
}
